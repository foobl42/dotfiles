{{- $supportDir := joinPath .chezmoi.sourceDir ".support" -}}
{{- $scriptsDir := joinPath $supportDir "scripts" -}}
{{- $configDir := dir .chezmoi.configFile -}}
{{- $identityFile := joinPath $configDir "chezmoi.key" -}}
{{- $hasIdentityFile := not (empty (stat $identityFile)) -}}
{{- $publicKey := "" -}}
{{- if $hasIdentityFile -}}
{{-   $publicKey = output
        (joinPath $scriptsDir "extract-age-public-key.bash") -}}
{{- end -}}
{{- $hasPublicKey := not (empty $publicKey) -}}

{{- if and $hasIdentityFile $hasPublicKey -}}
encryption = "age"
{{  end -}}
use-builtin-age = true
use-builtin-git = true

{{- if and $hasIdentityFile $hasPublicKey  }}

[age]
identity = "{{ $identityFile }}"
recipient = "{{ $publicKey }}"
{{- end  }}

[hooks.init.pre]
command = "{{ joinPath $scriptsDir "restore-age-identity-file.bash" }}"

[update]
apply = false

[warnings]
configFileTemplateHasChanged = false
